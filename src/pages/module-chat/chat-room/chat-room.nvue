<template>
  <VNavbar title="èŠå¤©">
    <template #right>
      <view>
        <VIcon :icon="'\ue6fd'" @click="navToChatSetRoute" />
      </view>
    </template>
  </VNavbar>

  <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
  <view ref="chatModuleRef" class="chat-module" :style="{ height: `${ chatModuleHeight }px` }" @touchend="chatModuleTouchendEvt">
    <scroll-view
      scroll-y
      class="scroll-y-view"
      :style="{ height: `${ chatModuleHeight }px` }"
      :scroll-with-animation="true"
      :scroll-into-view="scrollViewIntoId"
      >
      <!-- é¡¶éƒ¨å ä½å— -->
      <view style="height: 30rpx;" />

      <view v-for="(item, index) in chatMsgList" :id="`chatMsgItem-${ index }`" :key="index">
         <ChatMsgItem
          :chatItem="item"
          :chatIndex="index"
          :audioPlayStatus="audioPlayStatus"
          :chatAudioPlayIndex="chatAudioPlayIndex"
          :prevChatTime="index > 0 ? chatMsgList[index-1].create_time : '0'"
          @longpress="onChatMsgItemLongpressEvt"
          @changeAudioEvt="onChatMsgChangeAudioEvt"
        />
      </view>

      <!-- åº•éƒ¨å ä½å— -->
      <view id="chatMsgItem-last" style="height: 30rpx; background: red;" />
    </scroll-view>
  </view>

  <!-- åº•éƒ¨è¾“å…¥æ¡†ã€å·¥å…·æ  -->
  <view ref="inputModuleRef" class="input-module" :style="{ paddingBottom: (keyboardHeight || appStore.sysSafeAreaHeight) + 'px' }">
    <!-- è¾“å…¥æ -åŒºåŸŸ -->
    <view class="input-box">
      <VIcon v-if="inputMode === 'audio'" :size="45" :icon="'\ue607'" @click="changeInputMode('text')" />
      <VIcon v-else :size="45" :icon="'\ue606'" @click="changeInputMode('audio')" />
      <!-- è¾“å…¥æ¡† -->
      <view class="input-wrap">
        <!-- å½•éŸ³æŒ‰é’® -->
        <view v-if="inputMode === 'audio'" class="record-btn" :class="recordStatus ? 'record-btn-hover' : ''" @touchstart="voiceTouchStart" @touchend="voiceTouchEnd" @touchcancel="voiceTouchCancel" @touchmove="voiceTouchMove">
          <text class="record-btn-text">{{ recordStatus ? 'æ¾å¼€ ç»“æŸ':'æŒ‰ä½ è¯´è¯' }}</text>
        </view>
        
        <textarea
          v-else
          ref="textareaRef"
          v-model="inputValue"
          class="input-textarea"
          fixed
          auto-height
          :auto-focus="false"
          :show-confirm-bar="false"
          :adjust-position="false"
          inputmode="text"
          @focus="onTextareaFocusEvt"
          @blur="onTextareaBlurEvt"
        ></textarea>
      </view>

      <!-- è¡¨æƒ…icon -->
      <VIcon :icon="'\ue605'" :iconStyle="{ 'marginRight': '20rpx' }" :size="45" @click="changeInputMode('emoji')" />
      <!-- æ‰©å±•icon -->
      <VIcon v-if="!inputValue.length" :icon="'\ue603'" :size="45" @click="changeInputMode('action')" />
      <!-- å‘é€æŒ‰é’® -->
      <view v-else class="send-btn" @click="sendChatMsg('text', inputValue.trim())">
        <text class="send-btn-text">å‘ é€</text>
      </view>
    </view>

    <!-- å·¥å…·æ -åŒºåŸŸ -->
    <view v-if="['action', 'emoji'].includes(inputMode)" class="tool-box">
      <!-- å·¥å…· swiper -->
      <swiper v-if="inputMode === 'action'" indicator-dots class="action-swiper">
        <swiper-item v-for="(aItem, aIndex) in actionList" :key="aIndex" class="action-switerItem">
          <view v-for="(aSubItem, aSubIndex) in aItem" :key="aSubIndex" class="action-boxItem" :style="{ width: `${ actionBoxWidth }px` }" @click="clickActionItem(aSubItem.event)">
            <image :src="aSubItem.icon" mode="aspectFill" class="action-icon" />
            <text class="action-text">{{ aSubItem.name }}</text>
          </view>
        </swiper-item>
      </swiper>

      <!-- è¡¨æƒ… scroll -->
      <scroll-view v-if="inputMode === 'emoji'" scroll-y class="emoji-scroll">
        <view v-for="(eItem, eIndex) in emojiList" :key="eIndex" class="emoji-view">
          <text class="emoji-text" @click="selectEmojiItem(eItem)">{{ eItem }}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- chat èœå•å¼¹çª— -->
  <VPopup ref="chatMenuVPopupRef" mode="custom" :maskColor="false" :bodyWidth="240" :bodyHeight="chatMenuHeight" :tabbarHeight="inputModuleHeight">
    <view class="menu-popup">
      <view v-for="(mItem, mIndex) in chatMenuListComputed" :key="mIndex" class="menu-item" hover-class="bg-light" @click="clickChatMenuItem(mItem.event)">
        <text class="menu-item-text">{{ mItem.name }}</text>
      </view>
    </view>
  </VPopup>

  <!-- å½•éŸ³æç¤º -->
	<view v-if="recordStatus" class="record-popup    position-fixed   top-0 left-0 right-0 flex align-center justify-center" style="bottom: 105rpx;">
		<view class="record-view">
			<image class="record-img" src="@/static/audio/recording.gif" />
			<text class="record-text">{{ isCancelRecord ? 'æ¾å¼€æ‰‹æŒ‡ï¼Œå–æ¶ˆå‘é€' : 'æ‰‹æŒ‡ä¸Šæ»‘ï¼Œå–æ¶ˆå‘é€' }}</text>
		</view>
	</view>
</template>

<script setup lang="ts">
import config from '@/config';
import dayjs from 'dayjs';
import * as indexUtil from '@/utils'; 
import VPopup from '@/components/VPopup/VPopup.vue';
import { useAppStore } from '@/store';
import { useAudioHook, useRecorderHook } from '@/hooks/chatHook';

import type { IChatMsgItem } from '@/types/chat';

// #ifdef APP-NVUE
const domModule = uni.requireNativePlugin('dom');
// #endif

const appStore = useAppStore();

const { audioManager, audioPlayStatus, audioManagerPlay, audioManagerStop } = useAudioHook();

type VPopupType = InstanceType<typeof VPopup>;
// ä¼šè¯èœå• popup ref
const chatMenuVPopupRef = ref<VPopupType | null>(null);

type TInputMode = 'text' | 'action' | 'emoji' | 'audio';
// ä¼šè¯èœå• popup ref
const textareaRef = ref(null);
// è¾“å…¥æ¡†æ¨¡å¼ textï¼šè¾“å…¥æ–‡å­—ï¼Œemoticonï¼šè¡¨æƒ…ï¼Œactionï¼šæ“ä½œï¼Œaudioï¼šéŸ³é¢‘
const inputMode = ref<TInputMode>('text' as TInputMode);
// é”®ç›˜é«˜åº¦
const keyboardHeight = ref(0);

// èŠå¤©æ¶ˆæ¯ è¯­éŸ³ æ’­æ”¾ä¸‹æ ‡
const chatAudioPlayIndex = ref(-1);

// èŠå¤©æ–‡æœ¬
const inputValue = ref('');
// è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹å…‰æ ‡ä½ç½®
const inputBlurCursor = ref(0);

// èŠå¤©æ¨¡å—é«˜åº¦
const chatModuleHeight = ref(0);
// scrollView into id
const scrollViewIntoId = ref('');
const scrollViewIntoTimer = ref<number | null>(null);

// èŠå¤©æ¶ˆæ¯åˆ—è¡¨
const chatMsgList = ref<IChatMsgItem[]>([
  { from_user_id: 1, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'è‰¾ä¼¦æ²ƒå…‹', type: 'text', create_time: '1643252041', data: 'ğŸ˜€ä½ å¥½ï¼Œæˆ‘æ˜¯è‰¾ä¼¦æ²ƒå…‹ï¼Œæˆ‘æœ‰æˆåæ­Œæ›² Faded æ´»éå…¨çƒï¼Œä½ åº”è¯¥è¿˜æ²¡æœ‰å¬è¿‡å§ï¼Ÿ' },
  { from_user_id: 2, isremove: true, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'text', create_time: '1743242041', data: 'æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯' },
  { from_user_id: 1, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'text', create_time: '1743242021', data: 'æ²ƒå…‹ï¼Œæ²ƒå…‹ç‰›é€¼' },
  { from_user_id: 2, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'text', create_time: '1743242041', data: 'æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯' },
  { from_user_id: 2, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'text', create_time: '1743242041', data: 'æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯' },
  { from_user_id: 2, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'text', create_time: '1743242041', data: 'æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯' },
  { from_user_id: 1, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'text', create_time: '1743242021', data: 'æ²ƒå…‹ï¼Œæ²ƒå…‹ç‰›é€¼' },
  { from_user_id: 2, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'text', create_time: '1743242041', data: 'æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯æ˜¯é©¬ä¸ç›–ç‘æ–¯' },
  { from_user_id: 2, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'audio', create_time: '1743242041', data: 'https://samplelib.com/lib/preview/mp3/sample-12s.mp3', options: { time: 12 } },
  { from_user_id: 1, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'audio', create_time: '1743242041', data: 'https://samplelib.com/lib/preview/mp3/sample-3s.mp3', options: { time: 6 } },
  { from_user_id: 1, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'audio', create_time: '1743242041', data: 'https://ting8.yymp3.com/new13/xuyuteng2/11.mp3', options: { time: 60 } },
  { from_user_id: 2, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'video', create_time: '1743242041', data: 'https://v1.kwaicdn.com/ksc2/ymjv6otbCQkufuSFFA7bU4xY5Kq6-ZWMmq7s_lvjXMB4sGFyqDRs4RbZsLwkRvhOQ2VmsQyu3D_B0rnQxzuHv283DzeNakKF6ABTrK_66mVGxS2ik_r5fw7cRJUq2_Q7tATTak8BTOPw8MfSEhOoTtigjQToC8YT1sBFxlxWlrAoZyMw15VUyQwap-rMTI8A.mp4?pkey=AAVBibzO2WNWbVR3F7YyGoX3taYxxq9IYYUJhp1jLhYYWySxXIxD5LGAgBfUxwzk671EHSNzGZwogeEf4Up-MCMtJTMPpKIvIIhHbX-VnQsk5Ijm6zlGYEcbA8OzTI6gN-o&tag=1-1743947670-unknown-0-fywqwhmgif-daf24f891e5a8416&clientCacheKey=3xyn49gwifpqweu_hd15.mp4&di=3a652340&bp=10004&kwai-not-alloc=28&tt=hd15&ss=vp', options: { poster: 'https://p1.a.yximgs.com/upic/2022/08/08/18/BMjAyMjA4MDgxODAzMzFfMTU4NTQ2NjQ5N184MTMxMjY2ODE1NV8wXzM=_ccc_B29599bd317db97d567f08324f94bb1fb.jpg?tag=1-1743947670-xpcwebsearch-0-uticidee1b-93fcf5862edcc91f&clientCacheKey=3xyn49gwifpqweu_ccc.jpg&di=3a652340&bp=10004' } },
  { from_user_id: 1, isremove: false, avatar: 'https://img.yzcdn.cn/vant/cat.jpeg', nickname: 'é©¬ä¸ç›–ç‘æ–¯', type: 'video', create_time: '1743242041', data: 'https://v2.kwaicdn.com/ksc2/d1KCDOTXspS7vFt0rCUN3KoUYsxQY_s8fYH1GuarlltR6mHXdRvDQtEY7Bq9xqtDeQLzTPpCbjWJSJrSdWrEdO7mfWBY-_ZkeFL7bGJr3eqsnk0gbR-VRWr7Aq6HDu7bb-5X7aCuJfxHjU9-SYBqSXwtb-V5DpG9oynlXzmucRIbvuVwQExAmg11tHV3uoPG.mp4?pkey=AAUre9KTfe-RBkJjeG96WtFW4FIJINJpfENcbGQI1QqK8_vHgc3Fh8VReyEsPXuLKAreKM9ZqUaHX_xsPgsiq89YODx4llhzyKX4o2S45imeXlnY7a14XhV29DV-0VmLj-k&tag=1-1743947348-unknown-0-ijztxyvrwn-90e722c3ad61a271&clientCacheKey=3xvthfcxjznqzi6_hd15.mp4&di=3a652340&bp=10004&kwai-not-alloc=28&tt=hd15&ss=vp', options: { poster: 'https://p5.a.yximgs.com/upic/2023/01/26/14/BMjAyMzAxMjYxNDMzMDJfMTU4NTQ2NjQ5N185NDY0OTIwMjQ4Nl8wXzM=_ccc_B6c838d0bfe99aa7f044226f285defce7.jpg?tag=1-1743947648-xpcwebdetail-0-pcdeu5ptlw-e5f36260b6e7d393&clientCacheKey=3xvthfcxjznqzi6_ccc.jpg&di=3a652340&bp=10004' } },
]);

const chatModuleRef = ref(null);
const inputModuleRef = ref(null);
// åº•éƒ¨è¾“å…¥æ¡†é«˜åº¦ px
const inputModuleHeight = ref(0);

// chat èœå•åˆ—è¡¨
const chatMenuListData = ref([
  { name: 'å¤åˆ¶', event: 'copyMsg', isShow: true },
  { name: 'è½¬å‘', event: 'changeMsg', isShow: true },
  { name: 'æ”¶è—', event: 'collectMsg', isShow: true },
  { name: 'åˆ é™¤', event: 'deleteMsg', isShow: true },
  { name: 'æ’¤å›', event: 'revokeMsg', isShow: false }
]);
const chatMenuListComputed = computed(() => chatMenuListData.value.filter((item: any) => item.isShow));

// chat èœå•åˆ—è¡¨é«˜åº¦ rpx
const chatMenuHeight = computed(() => {
  const _menuItemHeight = 100;
  return chatMenuListComputed.value.length * _menuItemHeight;
});

// chat èœå•åˆ—è¡¨å®½åº¦ rpx
const actionBoxWidth = computed(() => {
  // const _menuItemHeight = 100;
  return appStore.systemInfo.windowWidth / 4;
});

// é•¿æŒ‰æ¿€æ´»çš„ chat msg index
const longpressActiveChatMsgIndex = ref(-1);

// æ‰©å±•åˆ—è¡¨
const actionList = ref([
  [
    { name: 'ç›¸å†Œ', icon: '/static/images/extends/pic.png', event: 'uploadImage' },
    { name: 'æ‹æ‘„', icon: '/static/images/extends/video.png', event: 'uploadVideo' },
    { name: 'æ”¶è—', icon: '/static/images/extends/shoucan.png', event: 'openFava' },
    { name: 'åç‰‡', icon: '/static/images/extends/man.png', event: 'sendCard' },
    { name: 'è¯­éŸ³é€šè¯', icon: '/static/images/extends/phone.png', event: '' },
    { name: 'ä½ç½®', icon: '/static/images/extends/path.png', event: '' }
  ],
  [
    { name: 'ç¤¼ç‰©', icon: '/static/images/extends/shoucan.png', event: '' },
    { name: 'è½¬è´¦', icon: '/static/images/extends/shoucan.png', event: '' },
    { name: 'éŸ³ä¹', icon: '/static/images/extends/shoucan.png', event: '' },
  ],
]);

// emoji è¡¨æƒ…åˆ—è¡¨
const emojiList = ref(config.emojiData);

watch(keyboardHeight, async (newkboardHeight) => {
  // console.log('é”®ç›˜é«˜åº¦:', newkboardHeight);
  await nextTick();
  // é‡æ–°è®¡ç®—èŠå¤©æ¨¡å—é«˜åº¦
  _calcChatModuleHeight();
});

onLoad(() => {
  // console.log('å½“å‰æ—¶é—´:', dayjs().format('YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss'));
  console.log('onLoad:', audioManager.value);
});

onMounted(() => {
  // fixbugï¼šä¸åŠ setTimeoutç®—å‡ºæ¥çš„å®½åº¦ä¼šä¸å‡†ï¼Œæå…¶å‘
  setTimeout(() => {
    _calcChatModuleHeight();
  }, 0);

  // #ifdef APP-NVUE
  uni.onKeyboardHeightChange(_keyboardListenerFunc);
  // #endif

  // this._initRecorderManager();
  // _initAudioManager();
});

// ç»„ä»¶å¸è½½æ—¶ç§»é™¤é”®ç›˜é«˜åº¦å˜åŒ–ç›‘å¬
onUnmounted(() => {
  // #ifdef APP-NVUE
  uni.offKeyboardHeightChange(_keyboardListenerFunc);
  // #endif
});

/**
 * 
 * é”®ç›˜é«˜åº¦å˜åŒ– å›è°ƒå‡½æ•°
 */
const _keyboardListenerFunc = (res: any)=> {
  // #ifdef APP-NVUE
  if (res.height === 0) {
    // @ts-ignore
    textareaRef.value.blur();
  }
  // #endif
};

/**
 * è®¡ç®—èŠå¤©æ¨¡å—é«˜åº¦
 */
const _calcChatModuleHeight = () => {
  const systemInfo = uni.getSystemInfoSync();
  // console.log('ç³»ç»Ÿä¿¡æ¯ï¼š', systemInfo);
  const windowHeight = systemInfo.windowHeight;
  // console.log('çª—å£é«˜åº¦ windowHeightï¼š', windowHeight);

  // #ifdef APP-NVUE
  setTimeout(() => {
    // è·å–æ¶ˆæ¯èŠ‚ç‚¹ä¿¡æ¯
    domModule.getComponentRect(chatModuleRef.value, (dom1: any) => {
      // è·å–åº•éƒ¨è¾“å…¥æ¡†èŠ‚ç‚¹ä¿¡æ¯
      domModule.getComponentRect(inputModuleRef.value, (dom2: any) => {
        inputModuleHeight.value = dom2.size.height;
        chatModuleHeight.value = windowHeight - dom1.size.top - dom2.size.height;
        // scrollView æ»šåŠ¨åˆ°åº•éƒ¨
        _scrollViewToIntoView();
      });
    });
  }, 100);
  // #endif

  // #ifndef APP-NVUE
  const chatModuleNode = uni.createSelectorQuery().select('.chat-module');
  chatModuleNode.boundingClientRect((rect1: any) => {
    // åº•éƒ¨æ¨¡å—é€‰æ‹©å™¨èŠ‚ç‚¹
    const bottomModuleNode = uni.createSelectorQuery().select('.input-module');
    bottomModuleNode.boundingClientRect((rect2: any) => {
      inputModuleHeight.value = rect2.height;
      chatModuleHeight.value = windowHeight - rect1.top - rect2.height;
      // scrollView æ»šåŠ¨åˆ°åº•éƒ¨
      _scrollViewToIntoView();
    }).exec();
  }).exec();
  // #endif
};

/**
 * scrollView æ»šåŠ¨æŒ‡å®šä½ç½®ï¼ˆé»˜è®¤åº•éƒ¨ï¼‰
 */
const _scrollViewToIntoView = (id = 'chatMsgItem-last') =>{
  // é¦–å…ˆæ¸…é™¤ä¸Šä¸€æ¬¡çš„å®šæ—¶å™¨
  if (scrollViewIntoTimer.value) clearTimeout(scrollViewIntoTimer.value);

  scrollViewIntoTimer.value = setTimeout(async () => {
    // å°†scrollIntoViewå±æ€§è®¾ç½®ä¸º "chatMsgItem-last"ï¼Œä»¥ä¾¿æ»šåŠ¨çª—å£åˆ°æœ€åä¸€æ¡æ¶ˆæ¯
    scrollViewIntoId.value = id;

    // ç­‰å¾… DOM æ›´æ–°ï¼Œå³ï¼šæ»šåŠ¨å®Œæˆ
    await nextTick();
    scrollViewIntoId.value = '';
  }, 10);
};

/**
 * æ‰“å¼€ä¼šè¯èœå• popup
 */
const onChatMsgItemLongpressEvt = async (cItemLeftX: number, cItemTopY: number, cItemIndex: number) => {
  // console.log('é•¿æŒ‰ä¼šè¯item:', cItemLeftX, cItemTopY, cItemIndex);
  // é•¿æŒ‰é€‰ä¸­çš„ index
  longpressActiveChatMsgIndex.value = cItemIndex;
  // æ‹¿åˆ°å½“å‰é€‰ä¸­çš„å¯¹è±¡
  const activeChatItem = chatMsgList.value[cItemIndex];
  // æ˜¯å¦æ˜¯è‡ªå·±
  const isSelf = (1 === activeChatItem.from_user_id);
  // ä¸æ˜¯è‡ªå·±å°±éšè— æ’¤å›item
  if (isSelf) {
    chatMenuListData.value[4].isShow = true;
  } else {
    chatMenuListData.value[4].isShow = false;
  }
  // ç­‰å¾… 100ms å†æ‰“å¼€ popup
  await indexUtil.sleepWait(500);
  // æ‰“å¼€ä¼šè¯èœå• popup
  chatMenuVPopupRef.value!.openVPopup(cItemLeftX, cItemTopY);
};

/**
 * ç‚¹å‡»èŠå¤©èœå•é¡¹
 */
const clickChatMenuItem = (eventName: string) => {
  // æ‹¿åˆ°å½“å‰é€‰ä¸­çš„å¯¹è±¡
  const activeChatItem = chatMsgList.value[longpressActiveChatMsgIndex.value];
  console.log('ç‚¹å‡»èŠå¤©èœå•é¡¹:', eventName, activeChatItem);

  switch (eventName) {
    // æ’¤å›æ¶ˆæ¯
    case 'revokeMsg':
      activeChatItem.isremove = true;
      break;
    // åˆ é™¤æ¶ˆæ¯
    case 'deleteMsg':
      // _delConvItem();
      break;
  }

  // å…³é—­ä¼šè¯èœå• popup
  chatMenuVPopupRef.value!.closeVPopup();
};

/**
 * è¾“å…¥æ¡†èšç„¦ç‚¹æ—¶è§¦å‘
 */
const onTextareaFocusEvt = (event: any) => {
  inputMode.value = 'text';
  keyboardHeight.value = event.detail.height;
  console.log('ç„¦æ—¶è§¦å‘:', event);
};

/**
 * è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶è§¦å‘
 */
const	onTextareaBlurEvt = (event: any) => {
  keyboardHeight.value = 0;
  console.log('å¤±å»ç„¦ç‚¹:', event);
  inputBlurCursor.value = event.detail.cursor;
};

/**
 * å‘é€èŠå¤©æ¶ˆæ¯ï¼šæ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘ã€è¡¨æƒ…
 * @param msgType æ¶ˆæ¯ç±»å‹
 * @param msgData æ¶ˆæ¯æ•°æ®
 * @param msgOpt æ¶ˆæ¯é€‰é¡¹
 */
const sendChatMsg = async (msgType = 'text', msgData = '', msgOpt = {}) => {
  let msgObj = {
    from_user_id: 1,
    isremove: false,
    avatar: 'https://img.yzcdn.cn/vant/cat.jpeg',
    nickname: 'è‰¾ä¼¦æ²ƒå…‹',
    create_time: '1643252041',
    type: msgType,
    data: '',
    options: msgOpt
  };
  
  msgObj.data = msgData;

  console.log('æ¶ˆæ¯ç±»å‹:', msgType, msgObj);

  chatMsgList.value.push(msgObj);

  // å‘é€æ–‡å­—æˆåŠŸï¼Œæ¸…ç©ºè¾“å…¥æ¡†
  if (msgType === 'text') inputValue.value = '';

  await indexUtil.sleepWait(100); // ç­‰å¾… 100ms
  _scrollViewToIntoView(); // scrollView æ»šåŠ¨åˆ°åº•éƒ¨
};

const { recordManager, recordStatus, isCancelRecord, recordStartY, recordManagerStart, recordManagerStop } = useRecorderHook({ sendRecordChatMsgFunc: sendChatMsg });

/**
 * TouchStart äº‹ä»¶ | å½•éŸ³å¼€å§‹
 */
const voiceTouchStart = (event: any) =>{
  // console.log('å½•éŸ³å¼€å§‹:', event);
  if (!recordManager.value) return uni.$uv.toast('æ— å½•éŸ³ manager');

  // å¼€å¯å½•éŸ³çŠ¶æ€
  recordStatus.value = 1;
  // é‡ç½®å–æ¶ˆå½•éŸ³çŠ¶æ€
  isCancelRecord.value = false;

  // #ifdef APP
  recordStartY.value = event.changedTouches[0].screenY;
  // #endif

  // #ifdef WEB
  recordStartY.value = event.changedTouches[0].pageY;
  // #endif

  // #ifdef MP
  recordStartY.value = event.changedTouches[0].screenY;
  // #endif

  // å…ˆåœæ­¢æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
  audioManagerStop();
  // å¼€å§‹-å½•éŸ³
  recordManagerStart();
};

/**
 * TouchEnd äº‹ä»¶ | å½•éŸ³ç»“æŸ
 */
const voiceTouchEnd = () =>{
  // åœæ­¢-å½•éŸ³
  recordManagerStop();
  recordStatus.value = 0;
};

/**
 * TouchCancel äº‹ä»¶ | å½•éŸ³è¢«æ‰“æ–­
 */
const voiceTouchCancel = () =>{
  // åœæ­¢å½•éŸ³
  recordManagerStop();
  recordStatus.value = 0;
  // å–æ¶ˆå½•éŸ³
  isCancelRecord.value = true;
};

/**
 * TouchMove äº‹ä»¶ | å½•éŸ³æ‰‹æŒ‡ç§»åŠ¨
 */
const voiceTouchMove = (event: any) => {
  // console.log('å½•éŸ³æ‰‹æŒ‡ç§»åŠ¨:', event);

  let recordMoveY = 0;
  
  // #ifdef APP
  recordMoveY = event.changedTouches[0].screenY;
  // #endif

  // #ifdef WEB
  recordMoveY = event.changedTouches[0].pageY;
  // #endif

  // #ifdef MP
  recordMoveY = event.changedTouches[0].screenY;
  // #endif
  
  const diffY = Math.abs(recordMoveY - recordStartY.value);
  isCancelRecord.value = (diffY >= 50);
};

/**
 * ç›‘å¬åˆ‡æ¢ éŸ³é¢‘ æ’­æ”¾/åœæ­¢
 * @param chatItem éŸ³é¢‘
 */
const onChatMsgChangeAudioEvt = (chatItem: IChatMsgItem, chatIndex: number) => {
  if (!audioManager.value) return uni.$uv.toast('æ— éŸ³é¢‘ manager');

  // å¦‚æœå½“å‰éŸ³é¢‘æ­£åœ¨æ’­æ”¾
  if (audioPlayStatus.value) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘ï¼Œåˆ™åœæ­¢æ’­æ”¾
    if (chatAudioPlayIndex.value === chatIndex) {
      audioManagerStop();
    } else {
      audioManagerPlay(chatItem.data);
    }
  // å¦‚æœå½“å‰æ— éŸ³é¢‘æ’­æ”¾
  } else {
    audioManagerPlay(chatItem.data);
  }

  // åŒæ­¥è®°å½•æ’­æ”¾ index
  chatAudioPlayIndex.value = chatIndex;
};

/**
 * èŠå¤©é¡µé¢ touchend äº‹ä»¶
 */
const chatModuleTouchendEvt = () => {
  // #ifdef APP-NVUE
  // @ts-ignore
  textareaRef.value.blur();
  // #endif
};

/**
 * åˆ‡æ¢è¾“å…¥æ¨¡å¼
 * textæ–‡å­—, emojiè¡¨æƒ…, actionæ“ä½œ, audioéŸ³é¢‘
 */
const	changeInputMode = (mode: TInputMode) => {
  if (inputMode.value !== mode) {
    inputMode.value = mode;
  } else {
    inputMode.value = ('text' as TInputMode);
  }

  // éšè—è½¯é”®ç›˜
  uni.hideKeyboard();
  // é‡æ–°è®¡ç®—èŠå¤©æ¨¡å—é«˜åº¦
  _calcChatModuleHeight();
};

/**
 * é€‰æ‹©è¡¨æƒ…
 */
const selectEmojiItem = (emoji: any) => {
  console.log('é€‰æ‹©è¡¨æƒ…:', emoji);

  // inputValue.value = inputValue.value += emoji;
  // inputValueæ ¹æ®inputBlurCursorä½ç½®æ’å…¥ emoji
  inputValue.value = inputValue.value.slice(0, inputBlurCursor.value) + emoji + inputValue.value.slice(inputBlurCursor.value);
};

/**
 * ç‚¹å‡»æ‰©å±•èœå•
 */
const clickActionItem = async (eventName: string) => {
  if (!eventName) return uni.$uv.toast('åŠŸèƒ½å¼€å‘ä¸­');

  // å‘é€å›¾ç‰‡
  if (eventName === 'uploadImage') {
    try {
      const imgRes = await uni.chooseImage({ count: 9 });
      console.log(imgRes);
      // TODO: ä¸Šä¼ å›¾ç‰‡
      (imgRes.tempFilePaths as string[]).forEach((imgItem: string) => {
        sendChatMsg('image', imgItem);
      });
    } catch (error) {
      console.log('é€‰å›¾é”™è¯¯ï¼š', error);
    }

    // console.log(imgRes);
    // imgUrl = await fileUtil.uploadFile(imgPath);
  }

  // å‘é€è§†é¢‘
  if (eventName === 'uploadVideo') {
    try {
      const videoRes = await uni.chooseVideo({
        sourceType: ['album', 'camera'],
        maxDuration: 60,
        camera: 'back'
      });
      console.log(videoRes);

      // TODO: ä¸Šä¼ è§†é¢‘
      sendChatMsg('video', videoRes.tempFilePath);
    } catch (error) {
      console.log('å½•åƒé”™è¯¯ï¼š', error);
    }
  }
};

/**
 * è¿›å…¥èŠå¤©è®¾ç½®é¡µé¢
 */
const navToChatSetRoute = () =>{
  console.log('è¿›å…¥èŠå¤©è®¾ç½®é¡µé¢');
  uni.$uv.route('/pages/module-chat/chat-set/chat-set', { name: 'uvui', age: 1 });
};
</script>

<style lang="scss" scoped>
@import './style.scss';
</style>
